class FanoosaWysiwygHtmlEditor{constructor(t){this.defaultConfig={textareaId:"",language:"fa",toolbarButtons:{undoRedo:!1,formatBlock:!1,textStyles:!1,alignment:!1,lists:!1,links:!1,colors:!1,misc:!1}},this.config={...this.defaultConfig,...t,toolbarButtons:{...this.defaultConfig.toolbarButtons,...t.toolbarButtons||{}}},this.config.textareaId?(this.textarea=document.getElementById(this.config.textareaId),this.textarea?this.initEditor():console.error(`FanoosaWysiwygHtmlEditor: Textarea with id '${this.config.textareaId}' not found`)):console.error("FanoosaWysiwygHtmlEditor: textareaId is required in config")}initEditor(){const t=document.createElement("div");t.className="fanoosa-editor-container","fa"===this.config.language?t.setAttribute("dir","rtl"):t.setAttribute("dir","ltr");const e=this.generateToolbarHtml();t.innerHTML=`\n            <div class="fanoosa-editor-container" id="fanoosaEditorContainer">\n                ${e}\n                \n                <div class="fanoosa-editor-content">\n                    <div class="fanoosa-editor" id="fanoosaEditor" contenteditable="true"></div>\n                </div>\n\n                <div class="fanoosa-status-bar">\n                    <span id="fanoosaCursorPosition">${"fa"===this.config.language?"خط 1، ستون 1":"Line 1, Column 1"}</span>\n                    <span id="fanoosaWordCount">${"fa"===this.config.language?"0 کلمه":"0 words"}</span>\n                </div>\n            </div>\n\n            <div id="fanoosaHtmlDialog" class="fanoosa-dialog" style="display: none;">\n                <h3>${"fa"===this.config.language?"ویرایش HTML":"HTML Editor"}</h3>\n                <textarea id="fanoosaHtmlEditor" rows="15"></textarea>\n                <div class="fanoosa-dialog-buttons">\n                    <button id="fanoosaCancelHtml">${"fa"===this.config.language?"انصراف":"Cancel"}</button>\n                    <button id="fanoosaSaveHtml" class="primary">${"fa"===this.config.language?"ذخیره":"Save"}</button>\n                </div>\n            </div>\n\n            <div id="fanoosaLinkDialog" class="fanoosa-dialog" style="display: none;">\n                <h3>${"fa"===this.config.language?"درج لینک":"Insert Link"}</h3>\n                <input type="text" id="fanoosaLinkUrl" placeholder="${"fa"===this.config.language?"آدرس URL (مثال: https://example.com)":"URL (e.g., https://example.com)"}">\n                <input type="text" id="fanoosaLinkText" placeholder="${"fa"===this.config.language?"متن نمایشی (اختیاری)":"Display text (optional)"}">\n                <div class="fanoosa-dialog-buttons">\n                    <button id="fanoosaCancelLink">${"fa"===this.config.language?"انصراف":"Cancel"}</button>\n                    <button id="fanoosaInsertLink" class="primary">${"fa"===this.config.language?"درج":"Insert"}</button>\n                </div>\n            </div>\n\n            <div id="fanoosaImageDialog" class="fanoosa-dialog" style="display: none;">\n                <h3>${"fa"===this.config.language?"درج تصویر":"Insert Image"}</h3>\n                <input type="text" id="fanoosaImageUrl" placeholder="${"fa"===this.config.language?"آدرس تصویر (مثال: https://example.com/image.jpg)":"Image URL (e.g., https://example.com/image.jpg)"}">\n                <input type="text" id="fanoosaImageAlt" placeholder="${"fa"===this.config.language?"متن جایگزین (اختیاری)":"Alt text (optional)"}">\n                <div class="fanoosa-dialog-buttons">\n                    <button id="fanoosaCancelImage">${"fa"===this.config.language?"انصراف":"Cancel"}</button>\n                    <button id="fanoosaInsertImageBtn" class="primary">${"fa"===this.config.language?"درج":"Insert"}</button>\n                </div>\n            </div>\n        `,this.textarea.style.display="none",this.textarea.parentNode.insertBefore(t,this.textarea.nextSibling),this.editor=t.querySelector("#fanoosaEditor"),this.textarea.value&&(this.editor.innerHTML=this.textarea.value),this.toolbar=t.querySelector("#fanoosaToolbar"),this.formatBlock=t.querySelector("#fanoosaFormatBlock"),this.colorPicker=t.querySelector("#fanoosaColorPicker"),this.cursorPosition=t.querySelector("#fanoosaCursorPosition"),this.wordCount=t.querySelector("#fanoosaWordCount"),this.editorContainer=t.querySelector("#fanoosaEditorContainer"),this.htmlDialog=t.querySelector("#fanoosaHtmlDialog"),this.htmlEditor=t.querySelector("#fanoosaHtmlEditor"),this.saveHtmlBtn=t.querySelector("#fanoosaSaveHtml"),this.cancelHtmlBtn=t.querySelector("#fanoosaCancelHtml"),this.linkDialog=t.querySelector("#fanoosaLinkDialog"),this.linkUrl=t.querySelector("#fanoosaLinkUrl"),this.linkText=t.querySelector("#fanoosaLinkText"),this.insertLinkBtn=t.querySelector("#fanoosaInsertLink"),this.cancelLinkBtn=t.querySelector("#fanoosaCancelLink"),this.imageDialog=t.querySelector("#fanoosaImageDialog"),this.imageUrl=t.querySelector("#fanoosaImageUrl"),this.imageAlt=t.querySelector("#fanoosaImageAlt"),this.insertImageBtn=t.querySelector("#fanoosaInsertImageBtn"),this.cancelImageBtn=t.querySelector("#fanoosaCancelImage"),this.currentSelection=null,this.currentColorCommand=null,this.currentImageSelection=null,this.bindEvents()}generateToolbarHtml(){const t="fa"===this.config.language,e=[];return this.config.toolbarButtons.undoRedo&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <button data-command="undo" title="${t?"بازگردانی (Ctrl+Z)":"Undo (Ctrl+Z)"}">\n                        <i class="bi bi-arrow-counterclockwise"></i>\n                    </button>\n                    <button data-command="redo" title="${t?"بازانجام (Ctrl+Y)":"Redo (Ctrl+Y)"}">\n                        <i class="bi bi-arrow-clockwise"></i>\n                    </button>\n                </div>\n            `),this.config.toolbarButtons.formatBlock&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <select id="fanoosaFormatBlock" title="${t?"سبک متن":"Text style"}">\n                        <option value="p">${t?"پاراگراف":"Paragraph"}</option>\n                        <option value="h1">${t?"عنوان 1":"Heading 1"}</option>\n                        <option value="h2">${t?"عنوان 2":"Heading 2"}</option>\n                        <option value="h3">${t?"عنوان 3":"Heading 3"}</option>\n                        <option value="h4">${t?"عنوان 4":"Heading 4"}</option>\n                        <option value="h5">${t?"عنوان 5":"Heading 5"}</option>\n                        <option value="h6">${t?"عنوان 6":"Heading 6"}</option>\n                        <option value="pre">${t?"کد":"Code"}</option>\n                    </select>\n                </div>\n            `),this.config.toolbarButtons.textStyles&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <button data-command="bold" title="${t?"پررنگ (Ctrl+B)":"Bold (Ctrl+B)"}">\n                        <i class="bi bi-type-bold"></i>\n                    </button>\n                    <button data-command="italic" title="${t?"ایتالیک (Ctrl+I)":"Italic (Ctrl+I)"}">\n                        <i class="bi bi-type-italic"></i>\n                    </button>\n                    <button data-command="underline" title="${t?"زیرخط‌دار (Ctrl+U)":"Underline (Ctrl+U)"}">\n                        <i class="bi bi-type-underline"></i>\n                    </button>\n                    <button data-command="strikeThrough" title="${t?"خط‌خورده":"Strikethrough"}">\n                        <i class="bi bi-type-strikethrough"></i>\n                    </button>\n                </div>\n            `),this.config.toolbarButtons.alignment&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <button data-command="justifyLeft" title="${t?"تراز به چپ":"Align left"}">\n                        <i class="bi bi-text-left"></i>\n                    </button>\n                    <button data-command="justifyCenter" title="${t?"تراز به وسط":"Align center"}">\n                        <i class="bi bi-text-center"></i>\n                    </button>\n                    <button data-command="justifyRight" title="${t?"تراز به راست":"Align right"}">\n                        <i class="bi bi-text-right"></i>\n                    </button>\n                    <button data-command="justifyFull" title="${t?"تراز به دو طرف":"Justify"}">\n                        <i class="bi bi-justify"></i>\n                    </button>\n                </div>\n            `),this.config.toolbarButtons.lists&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <button data-command="insertOrderedList" title="${t?"لیست شماره‌دار":"Numbered list"}">\n                        <i class="bi bi-list-ol"></i>\n                    </button>\n                    <button data-command="insertUnorderedList" title="${t?"لیست نقطه‌ای":"Bullet list"}">\n                        <i class="bi bi-list-ul"></i>\n                    </button>\n                    <button data-command="outdent" title="${t?"کاهش تورفتگی":"Decrease indent"}">\n                        <i class="bi bi-unindent"></i>\n                    </button>\n                    <button data-command="indent" title="${t?"افزایش تورفتگی":"Increase indent"}">\n                        <i class="bi bi-indent"></i>\n                    </button>\n                </div>\n            `),this.config.toolbarButtons.links&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <button data-command="createLink" title="${t?"درج لینک":"Insert link"}">\n                        <i class="bi bi-link-45deg"></i>\n                    </button>\n                    <button data-command="unlink" title="${t?"حذف لینک":"Remove link"}">\n                        <i class="bi bi-link-45deg"></i><i class="bi bi-x small-icon"></i>\n                    </button>\n                    <button data-command="insertImage" title="${t?"درج تصویر":"Insert image"}">\n                        <i class="bi bi-image"></i>\n                    </button>\n                </div>\n            `),this.config.toolbarButtons.colors&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <button data-command="foreColor" title="${t?"رنگ متن":"Text color"}">\n                        <i class="bi bi-fonts"></i>\n                    </button>\n                    <button data-command="hiliteColor" title="${t?"رنگ پس‌زمینه":"Background color"}">\n                        <i class="bi bi-paint-bucket"></i>\n                    </button>\n                    <input type="color" id="fanoosaColorPicker" style="position: absolute; opacity: 0; pointer-events: none;">\n                </div>\n            `),this.config.toolbarButtons.misc&&e.push(`\n                <div class="fanoosa-toolbar-group">\n                    <button data-command="insertHorizontalRule" title="${t?"درج خط افقی":"Horizontal line"}">\n                        <i class="bi bi-hr"></i>\n                    </button>\n                    <button data-command="removeFormat" title="${t?"حذف فرمت":"Clear formatting"}">\n                        <i class="bi bi-eraser-fill"></i>\n                    </button>\n                    <button data-command="toggleFullscreen" title="${t?"تمام‌صفحه":"Fullscreen"}">\n                        <i class="bi bi-fullscreen"></i>\n                    </button>\n                    <button data-command="showHTML" title="${t?"نمایش HTML":"HTML view"}">\n                        <i class="bi bi-code-slash"></i>\n                    </button>\n                </div>\n            `),`<div class="fanoosa-toolbar" id="fanoosaToolbar">${e.join("")}</div>`}bindEvents(){this.toolbar.addEventListener("click",(t=>{"BUTTON"===t.target.tagName&&t.target.dataset.command?(t.preventDefault(),this.executeCommand(t.target.dataset.command)):"BUTTON"===t.target.parentElement.tagName&&t.target.parentElement.dataset.command&&(t.preventDefault(),this.executeCommand(t.target.parentElement.dataset.command))})),this.formatBlock.addEventListener("change",(()=>{this.executeCommand("formatBlock",this.formatBlock.value)})),this.colorPicker.addEventListener("input",(()=>{this.currentColorCommand&&(document.execCommand(this.currentColorCommand,!1,this.colorPicker.value),this.editor.focus(),this.currentColorCommand=null)})),this.saveHtmlBtn.addEventListener("click",(t=>{t.preventDefault(),this.editor.innerHTML=this.htmlEditor.value,this.closeAllDialogs(),this.updateToolbar(),this.syncTextarea()})),this.cancelHtmlBtn.addEventListener("click",(t=>{t.preventDefault(),this.closeAllDialogs()})),this.insertLinkBtn.addEventListener("click",(t=>{t.preventDefault();const e=this.linkUrl.value.trim(),n=this.linkText.value.trim();if(e){const t=window.getSelection();t.removeAllRanges(),this.currentSelection&&(t.addRange(this.currentSelection),n?document.execCommand("insertHTML",!1,`<a href="${e}" target="_blank">${n}</a>`):t.toString().trim()?document.execCommand("createLink",!1,e):document.execCommand("insertHTML",!1,`<a href="${e}" target="_blank">${e}</a>`))}this.closeAllDialogs(),this.updateToolbar(),this.syncTextarea()})),this.cancelLinkBtn.addEventListener("click",(t=>{t.preventDefault(),this.closeAllDialogs()})),this.insertImageBtn.addEventListener("click",(t=>{t.preventDefault();const e=this.imageUrl.value.trim(),n=this.imageAlt.value.trim();if(e){const t=`<img src="${e}" ${n?`alt="${n}"`:""} style="max-width: 100%; height: auto;">`;if(this.currentImageSelection){const e=window.getSelection();e.removeAllRanges(),e.addRange(this.currentImageSelection);const n=this.currentImageSelection;n.deleteContents();const o=document.createElement("div");o.innerHTML=t;const i=document.createDocumentFragment();let a,s;for(;a=o.firstChild;)s=i.appendChild(a);n.insertNode(i),s&&(n.setStartAfter(s),n.setEndAfter(s),e.removeAllRanges(),e.addRange(n))}}this.closeAllDialogs(),this.editor.focus(),this.updateToolbar(),this.syncTextarea()})),this.cancelImageBtn.addEventListener("click",(t=>{t.preventDefault(),this.closeAllDialogs()})),this.editor.addEventListener("input",(()=>{this.updateToolbar(),this.syncTextarea()})),this.editor.addEventListener("keyup",(()=>{this.updateToolbar(),this.syncTextarea()})),this.editor.addEventListener("mouseup",this.updateToolbar.bind(this)),this.editor.addEventListener("click",this.updateToolbar.bind(this)),this.editor.addEventListener("keydown",(t=>{if(t.ctrlKey&&"k"===t.key){t.preventDefault();const e=window.getSelection();e.rangeCount>0&&(this.currentSelection=e.getRangeAt(0).cloneRange()),this.showLinkDialog()}"Shift"!==t.key&&"Control"!==t.key&&"Alt"!==t.key&&setTimeout((()=>{this.updateToolbar(),this.syncTextarea()}),0)}))}executeCommand(t,e=null){if("toggleFullscreen"!==t)if("showHTML"!==t){if("createLink"===t){const t=window.getSelection();return t.rangeCount>0&&(this.currentSelection=t.getRangeAt(0).cloneRange()),void this.showLinkDialog()}if("insertImage"!==t)return"foreColor"===t||"hiliteColor"===t?(this.currentColorCommand=t,void this.colorPicker.click()):void("unlink"!==t?(document.execCommand(t,!1,e),this.editor.focus(),this.updateToolbar(),this.syncTextarea()):document.execCommand("unlink",!1,null));this.showImageDialog()}else this.showHTMLDialog();else this.editorContainer.classList.toggle("fanoosa-fullscreen")}updateToolbar(){const t=window.getSelection();if(!t.rangeCount)return;t.getRangeAt(0).commonAncestorContainer.parentElement;this.toolbar.querySelectorAll('[data-command="bold"], [data-command="italic"], [data-command="underline"], [data-command="strikeThrough"]').forEach((t=>{t.classList.toggle("active",document.queryCommandState(t.dataset.command))})),this.toolbar.querySelectorAll('[data-command^="justify"]').forEach((t=>{t.classList.toggle("active",document.queryCommandValue("justify")===t.dataset.command.replace("justify","").toLowerCase())})),this.toolbar.querySelectorAll('[data-command^="insert"], [data-command^="outdent"], [data-command^="indent"]').forEach((t=>{const e=t.dataset.command;"insertOrderedList"!==e&&"insertUnorderedList"!==e||t.classList.toggle("active",document.queryCommandState(e))})),this.updateCursorPosition()}updateCursorPosition(){const t=window.getSelection();if(!t.rangeCount)return;const e=t.getRangeAt(0),n=e.cloneRange();n.selectNodeContents(this.editor),n.setEnd(e.endContainer,e.endOffset);const o=this.editor.innerHTML.split(/<div>|<br>|<p>|<\/p>|<\/div>/);let i=1,a=1;for(let t=0;t<o.length;t++)t<o.length-1?(i++,a=1):a=o[t].length+1;"fa"===this.config.language?this.cursorPosition.textContent=`خط ${i}، ستون ${a}`:this.cursorPosition.textContent=`Line ${i}, Column ${a}`;const s=this.editor.textContent||this.editor.innerText,l=s.trim()?s.trim().split(/\s+/).filter((t=>t.length>0)).length:0;"fa"===this.config.language?this.wordCount.textContent=`${l} کلمه`:this.wordCount.textContent=`${l} words`}showHTMLDialog(){this.htmlEditor.value=this.editor.innerHTML,this.htmlDialog.style.display="block",document.body.appendChild(this.createOverlay())}showLinkDialog(){this.linkUrl.value="",this.linkText.value="",this.linkDialog.style.display="block",document.body.appendChild(this.createOverlay()),this.linkUrl.focus()}showImageDialog(){this.imageUrl.value="",this.imageAlt.value="";const t=window.getSelection();t.rangeCount>0&&(this.currentImageSelection=t.getRangeAt(0).cloneRange()),this.imageDialog.style.display="block",document.body.appendChild(this.createOverlay()),this.imageUrl.focus()}createOverlay(){const t=document.createElement("div");return t.className="overlay",t.onclick=this.closeAllDialogs.bind(this),t}closeAllDialogs(){[this.htmlDialog,this.linkDialog,this.imageDialog].forEach((t=>{t.style.display="none"}));const t=document.querySelector(".fanoosa-overlay");t&&t.remove(),this.editor.focus()}syncTextarea(){this.textarea.value=this.editor.innerHTML}getContent(){return this.editor.innerHTML}setContent(t){this.editor.innerHTML=t,this.syncTextarea()}}